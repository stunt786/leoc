<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster & Relief GIS Map - LEOC</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .legend {
            padding: 6px 8px;
            font: 14px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize the map
        const map = L.map('map', {
            minZoom: 10,  // Minimum zoom to prevent going beyond boundaries
            maxZoom: 18,
            worldCopyJump: false  // Prevents showing multiple worlds when zooming out
        }).setView([29.47, 81.0], 12);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add Esri World Imagery as an alternative layer
        const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Add layer control
        const baseLayers = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            "Satellite View": esriSatellite
        };

        L.control.layers(baseLayers).addTo(map);

        // Variables to store boundary data
        let boundaryBounds = null;
        let municipalityBoundaryLayer = null;

        // Define marker clusters for better performance
        const distributionMarkers = L.layerGroup().addTo(map);
        const disasterMarkers = L.layerGroup().addTo(map);
        const helipadMarkers = L.layerGroup().addTo(map);
        const wardBoundaries = L.layerGroup().addTo(map);
        const boundaryLayer = L.layerGroup();  // This is the layer group for municipality boundary (not added to map by default)

        // Add layer control for markers
        const overlays = {
            "Relief Distributions": distributionMarkers,
            "Disasters": disasterMarkers,
            "Helipads": helipadMarkers,
            "Wards": wardBoundaries,
            "Thalara Boundary": boundaryLayer
        };
        L.control.layers(null, overlays, { collapsed: false }).addTo(map);

        // Function to show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Function to hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Function to format tooltip content
        function formatDistributionTooltip(dist) {
            return `
                <div>
                    <h5 style="margin: 0 0 10px 0; color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 5px; font-size: 16px;">Relief Distribution</h5>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Disaster:</b> ${dist.disaster_type || 'N/A'} (${dist.disaster_date || 'N/A'})</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Beneficiary:</b> ${dist.beneficiary_name}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Location:</b> ${dist.location}, Ward ${dist.ward}</p>
                    <p style="margin: 5px 0; color: #198754; font-size: 14px;"><b>Relief Items:</b> ${dist.relief_items || 'N/A'}</p>
                    <p style="margin: 5px 0; color: #0d6efd; font-size: 14px;"><b>Cash:</b> ‚Çπ${dist.cash_received?.toFixed(2) || '0.00'}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Notes:</b> ${dist.notes || 'N/A'}</p>
                    <p style="margin: 5px 0; font-size: 12px;"><small>ID: ${dist.id}</small></p>
                </div>
            `;
        }

        function formatDisasterTooltip(disaster) {
            return `
                <div>
                    <h5 style="margin: 0 0 10px 0; color: #0d6efd; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; font-size: 16px;">Disaster Record</h5>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Type:</b> ${disaster.disaster_type}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Date:</b> ${disaster.disaster_date}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Ward:</b> ${disaster.ward}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Affected Households:</b> ${disaster.affected_households}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Affected People:</b> ${disaster.affected_people}</p>
                </div>
            `;
        }

        function formatHelipadTooltip(helipad) {
            return `
                <div>
                    <h5 style="margin: 0 0 10px 0; color: #198754; border-bottom: 2px solid #198754; padding-bottom: 5px; font-size: 16px;">üöÅ Helipad Location</h5>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Place:</b> ${helipad.place}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Ward:</b> ${helipad.ward}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Open Area:</b> ${helipad.open_area} m¬≤</p>
                    <p style="margin: 5px 0; font-size: 14px;"><b>Road Access:</b> ${helipad.road_access}</p>
                </div>
            `;
        }

        // Function to load map data
        async function loadMapData() {
            showLoading();

            try {
                // Load map data (distributions and disasters)
                const mapResponse = await fetch('/api/map-data');
                const mapData = await mapResponse.json();

                if (mapData.success) {
                    // Clear existing markers
                    distributionMarkers.clearLayers();
                    disasterMarkers.clearLayers();

                    // Add distribution markers
                    mapData.distributions.forEach(dist => {
                        const marker = L.marker([dist.latitude, dist.longitude], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: "<div style='background-color:#dc3545; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);'><i class='bi bi-house-fill' style='color:white; font-size:20px;'></i></div>",
                                iconSize: [36, 36],
                                iconAnchor: [18, 18]
                            })
                        })
                            .bindTooltip(formatDistributionTooltip(dist), {
                                permanent: false,
                                direction: 'top',
                                className: 'custom-tooltip'
                            });

                        distributionMarkers.addLayer(marker);
                    });

                    // Add disaster markers
                    mapData.disasters.forEach(disaster => {
                        const marker = L.marker([disaster.latitude, disaster.longitude], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: "<div style='background-color:#ff6b35; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);'><i class='bi bi-exclamation-triangle-fill' style='color:white; font-size:20px;'></i></div>",
                                iconSize: [36, 36],
                                iconAnchor: [18, 18]
                            })
                        })
                            .bindTooltip(formatDisasterTooltip(disaster), {
                                permanent: false,
                                direction: 'top',
                                className: 'custom-tooltip'
                            });

                        disasterMarkers.addLayer(marker);
                    });

                    // Fit bounds to show all markers if any exist
                    if (mapData.distributions.length > 0 || mapData.disasters.length > 0) {
                        const allCoords = [
                            ...mapData.distributions.map(d => [d.latitude, d.longitude]),
                            ...mapData.disasters.map(d => [d.latitude, d.longitude])
                        ];

                        if (allCoords.length > 0) {
                            const group = new L.featureGroup([
                                ...mapData.distributions.map(d => L.marker([d.latitude, d.longitude])),
                                ...mapData.disasters.map(d => L.marker([d.latitude, d.longitude]))
                            ]);
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    }
                }

                // Load ward boundaries
                try {
                    const wardsResponse = await fetch('/thalara_wards.json');
                    if (wardsResponse.ok) {
                        const wardsData = await wardsResponse.json();

                        wardBoundaries.clearLayers();

                        L.geoJSON(wardsData, {
                            style: function (feature) {
                                return {
                                    fillColor: '#ffeb3b',
                                    color: '#fbc02d',
                                    weight: 1.5,
                                    fillOpacity: 0.15
                                };
                            },
                            onEachFeature: function (feature, layer) {
                                // Add tooltip
                                if (feature.properties && feature.properties.name) {
                                    layer.bindTooltip(`Ward: ${feature.properties.name}`, {
                                        sticky: false
                                    });

                                    // Add popup
                                    layer.bindPopup(`<b>Ward:</b> ${feature.properties.name}`);
                                }

                                // Highlight on mouseover
                                layer.on({
                                    mouseover: function (e) {
                                        this.setStyle({
                                            weight: 2.5,
                                            fillOpacity: 0.25
                                        });
                                    },
                                    mouseout: function (e) {
                                        this.setStyle({
                                            weight: 1.5,
                                            fillOpacity: 0.15
                                        });
                                    }
                                });
                            }
                        }).addTo(wardBoundaries);
                    }
                } catch (error) {
                    console.error('Error loading ward boundaries:', error);
                }

                // Load municipality boundary
                try {
                    const boundaryResponse = await fetch('/thalara_boundary.json');
                    if (boundaryResponse.ok) {
                        const boundaryData = await boundaryResponse.json();

                        // Create new boundary geojson layer
                        const newBoundaryLayer = L.geoJSON(boundaryData, {
                            style: function (feature) {
                                return {
                                    fillColor: 'transparent',
                                    color: '#0d6efd',
                                    weight: 3,
                                    opacity: 0.8
                                };
                            },
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup('<b>Thalara Municipality Boundary</b>');
                            }
                        });

                        // Clear the existing boundary layer from the layer group
                        boundaryLayer.clearLayers();

                        // Add the new boundary to the layer group
                        newBoundaryLayer.eachLayer(layer => {
                            boundaryLayer.addLayer(layer);
                        });

                        // Calculate bounds from the boundary geometry
                        if (boundaryData && boundaryData.features && boundaryData.features.length > 0) {
                            const geom = boundaryData.features[0].geometry;
                            if (geom) {
                                // Calculate bounds from coordinates
                                let lats = [];
                                let lons = [];

                                function extractCoords(coords) {
                                    for (let c of coords) {
                                        if (typeof c[0] === 'number' && typeof c[1] === 'number') {
                                            lons.push(c[0]);
                                            lats.push(c[1]);
                                        } else {
                                            extractCoords(c);
                                        }
                                    }
                                }

                                if (geom.type === 'Polygon') {
                                    extractCoords(geom.coordinates[0]); // Exterior ring
                                } else if (geom.type === 'MultiPolygon') {
                                    for (let polygon of geom.coordinates) {
                                        extractCoords(polygon[0]); // Exterior ring of each polygon
                                    }
                                }

                                if (lats.length > 0 && lons.length > 0) {
                                    boundaryBounds = L.latLngBounds(
                                        [Math.min(...lats), Math.min(...lons)],
                                        [Math.max(...lats), Math.max(...lons)]
                                    );

                                    // Set maximum bounds to prevent panning outside boundary
                                    map.setMaxBounds(boundaryBounds.pad(0.1));

                                    // Fit map to boundary initially
                                    map.fitBounds(boundaryBounds);

                                    // Add event listener to enforce bounds
                                    map.on('moveend', function () {
                                        if (!boundaryBounds.contains(map.getBounds().getNorthWest()) ||
                                            !boundaryBounds.contains(map.getBounds().getSouthEast())) {
                                            map.fitBounds(boundaryBounds, { animate: false });
                                        }
                                    });
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading municipality boundary:', error);
                }

                // Load helipad locations
                try {
                    const helipadResponse = await fetch('/helipad_locations.json');
                    if (helipadResponse.ok) {
                        const helipadData = await helipadResponse.json();

                        helipadMarkers.clearLayers();

                        helipadData.features.forEach(feature => {
                            const props = feature.properties;
                            const coords = feature.geometry.coordinates;

                            const marker = L.marker([coords[1], coords[0]], {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: "<div style='background-color:#198754; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);'><span style='color:white; font-size:22px;'>üöÅ</span></div>",
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            })
                                .bindTooltip(formatHelipadTooltip(props), {
                                    permanent: false,
                                    direction: 'top',
                                    className: 'custom-tooltip'
                                });

                            helipadMarkers.addLayer(marker);
                        });
                    }
                } catch (error) {
                    console.error('Error loading helipad locations:', error);
                }

            } catch (error) {
                console.error('Error loading map data:', error);
            } finally {
                hideLoading();
            }
        }

        // Load data when map is ready
        map.whenReady(() => {
            loadMapData();

            // Refresh data every 30 seconds
            setInterval(loadMapData, 30000);
        });

        // Add zoom restriction to prevent zooming out too far
        map.on('zoomend', function () {
            if (map.getZoom() < 10) {
                map.setZoom(10);
            }
        });

        // Add custom CSS for tooltips
        const style = document.createElement('style');
        style.innerHTML = `
            .custom-tooltip {
                background: rgba(255, 255, 255, 0.95) !important;
                border: 2px solid #ddd !important;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                padding: 10px !important;
                border-radius: 8px !important;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
                font-size: 14px !important;
                color: #333 !important;
                max-width: 350px !important;
            }
            .custom-div-icon {
                background: transparent !important;
                border: none !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>