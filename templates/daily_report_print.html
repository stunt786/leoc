<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>दैनिक विपद् प्रतिवेदन - {{ start_bs|to_nepali_num }}{% if start_bs != end_bs %} देखि {{ end_bs|to_nepali_num
        }}{% endif %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        @page {
            size: A4;
            margin: 5mm;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            .container {
                width: 100%;
                max-width: none;
                padding: 0;
            }

            .report-content {
                page-break-inside: avoid;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #333;
            background: white;
        }

        .report-header {
            position: relative;
            text-align: center;
            border-bottom: 2px double #1a472a;
            padding-bottom: 5px;
            margin-bottom: 10px;
            min-height: 80px;
        }

        .report-header img {
            position: absolute;
            left: 5px;
            top: 0;
            height: 70px;
            width: auto;
        }

        .report-header h1 {
            color: #d32f2f;
            font-size: 18pt;
            font-weight: bold;
            margin: 0;
            line-height: 1.1;
        }

        .report-header h2 {
            color: #1a472a;
            font-size: 12pt;
            margin: 2px 0;
            font-weight: bold;
        }

        .report-header h3 {
            color: #1a472a;
            font-size: 11pt;
            margin: 1px 0;
            font-weight: 500;
        }

        .report-header h4 {
            color: #2c5282;
            font-size: 10pt;
            margin: 2px 0;
            font-weight: bold;
        }

        .report-header h5 {
            color: #2c5282;
            font-size: 12pt;
            margin-top: 5px;
            text-decoration: underline;
            font-weight: bold;
        }

        .report-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 9pt;
        }

        .section-title {
            background-color: #2c5282;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 10pt;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .section-title.brown {
            background-color: #744210;
        }

        .section-title.gray {
            background-color: #4a5568;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            margin-bottom: 10px;
        }

        .data-table th {
            background-color: #2c5282;
            color: white;
            padding: 4px 3px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #1a365d;
            font-size: 8pt;
        }

        .data-table th.brown {
            background-color: #744210;
            border-color: #553c0d;
        }

        .data-table td {
            padding: 3px 3px;
            text-align: center;
            border: 1px solid #cbd5e0;
            vertical-align: middle;
            font-size: 8pt;
        }

        .data-table tr:nth-child(even) {
            background-color: #f7fafc;
        }

        .data-table tr.total-row {
            background-color: #e2e8f0;
            font-weight: bold;
        }

        .infrastructure-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .infrastructure-item {
            display: flex;
            align-items: center;
            padding: 5px;
            background-color: #f7fafc;
            border-radius: 4px;
            border-left: 3px solid #2c5282;
            font-size: 8pt;
        }

        .infrastructure-item i {
            margin-right: 10px;
            font-size: 14pt;
        }

        .infrastructure-item .label {
            font-weight: bold;
            margin-right: 10px;
        }

        .status-normal {
            color: #28a745;
        }

        .status-disrupted {
            color: #dc3545;
        }

        .advisory-item {
            padding: 5px;
            margin-bottom: 3px;
            border-left: 3px solid #ffc107;
            background-color: #fffaf0;
            font-size: 8pt;
        }

        .advisory-item.critical {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }

        .advisory-item.high {
            border-left-color: #fd7e14;
            background-color: #fff7ed;
        }

        .report-footer {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #cbd5e0;
            text-align: center;
            font-size: 8pt;
            color: #666;
            font-style: italic;
        }



        .sit-rep-box {
            position: absolute;
            top: 0;
            right: 0;
            border: 1px solid #2c5282;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #2c5282;
            background: rgba(255, 255, 255, 0.9);
            font-size: 8pt;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            color: white;
            padding: 10px 5px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 85px;
            position: relative;
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #d97706 0%, #92400e 100%);
            color: white;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #059669 0%, #065f46 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #0284c7 0%, #075985 100%);
        }

        .stat-card.dark {
            background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
        }

        .stat-card i {
            position: absolute;
            top: 7px;
            left: 7px;
            font-size: 13pt;
            opacity: 0.7;
        }

        .stat-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            text-align: center;
            padding-top: 5px;
        }

        .stat-card .number {
            font-size: 18pt;
            font-weight: 800;
            line-height: 1.1;
        }

        .stat-card .label {
            font-size: 10.5pt;
            font-weight: 700;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            opacity: 0.95;
            margin-top: 2px;
        }

        .print-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .btn-print {
            background-color: #2c5282;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11pt;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-print:hover {
            background-color: #1a365d;
        }

        .btn-pdf {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11pt;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-pdf:hover {
            background-color: #c82333;
            color: white;
        }

        .btn-image {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11pt;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-image:hover {
            background-color: #218838;
        }

        .date-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 200px;
            border: 1px solid #e2e8f0;
        }

        .date-selector .form-control {
            margin-bottom: 10px;
        }

        .date-selector .btn-filter {
            width: 100%;
            background-color: #2c5282;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .date-selector .btn-filter:hover {
            background-color: #1a365d;
        }

        .event-log-item {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 9pt;
        }

        .event-log-item:last-child {
            border-bottom: none;
        }

        .badge-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 8pt;
        }

        .badge-active {
            background-color: #17a2b8;
            color: white;
        }

        .badge-completed {
            background-color: #28a745;
            color: white;
        }

        .badge-pending {
            background-color: #ffc107;
            color: #333;
        }
    </style>
</head>

<body>
    <!-- Print Actions -->
    <div class="print-actions no-print">
        <button class="btn-print" onclick="window.print()">
            <i class="bi bi-printer"></i> प्रतिवेदन प्रिन्ट
        </button>
        <button class="btn-pdf" onclick="saveAsPDF()">
            <i class="bi bi-download"></i> PDF
        </button>
        <button class="btn-image" onclick="saveAsImage()">
            <i class="bi bi-download"></i> Image
        </button>
    </div>

    <!-- Date Selector -->
    <div class="date-selector no-print">
        <label class="form-label mb-1"><strong>मिति फिल्टर (BS):</strong></label>
        <div class="mb-2">
            <small class="text-muted d-block mb-1">देखि:</small>
            <input type="text" id="fromDateBS" class="form-control form-control-sm" value="{{ start_bs }}"
                placeholder="YYYY-MM-DD">
        </div>
        <div class="mb-3">
            <small class="text-muted d-block mb-1">सम्म:</small>
            <input type="text" id="toDateBS" class="form-control form-control-sm" value="{{ end_bs }}"
                placeholder="YYYY-MM-DD">
        </div>
        <button class="btn-filter" onclick="applyFilter()">
            <i class="bi bi-filter"></i> फिल्टर लागू गर्नुहोस्
        </button>
        <small class="text-muted d-block mt-2" style="font-size: 8pt;">Format: YYYY-MM-DD</small>
    </div>

    <div class="container mt-5">
        <!-- Report Header -->
        <div class="report-header">
            {% if data.sit_rep_no != 'N/A' %}
            <div class="sit-rep-box">
                Sit Rep No: {{ data.sit_rep_no }}
            </div>
            {% endif %}
            <img src="{{ url_for('static', filename='Emblem_of_Nepal.png') }}" alt="Logo">
            <h1>थलारा गाउँपालिका</h1>
            <h2>गाउँकार्यपालिकाको कार्यालय</h2>
            <h3>खोली, बझाङ</h3>
            <h4>स्थानीय आपतकालिन कार्य संचालन केन्द्र (LEOC)</h4>
            <h5>दैनिक विपद् बुलेटीन</h5>
        </div>

        <!-- Report Meta -->
        <div class="report-meta">
            <div>
                <strong>मिति (BS):</strong> {{ start_bs|to_nepali_num }}{% if start_bs != end_bs %} देखि {{
                end_bs|to_nepali_num }}{% endif %}
            </div>
            <div>
                <strong>आजको मौसम:</strong>
                {% if data.situation_report and data.situation_report.weather_conditions %}
                {{ data.situation_report.weather_conditions }}
                {% else %}
                खुलेको छैन
                {% endif %}
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="stats-cards">
            <!-- Total Incidents -->
            <div class="stat-card">
                <i class="bi bi-exclamation-triangle"></i>
                <div class="stat-info">
                    <span class="number">{{ data.total_stats.incidents|to_nepali_num }}</span>
                    <span class="label">जम्मा घटनाहरू</span>
                </div>
            </div>

            <!-- Deaths -->
            <div class="stat-card danger">
                <i class="bi bi-person-x-fill"></i>
                <div class="stat-info">
                    <span class="number">{{ data.total_stats.deaths|to_nepali_num }}</span>
                    <span class="label">मृतक संख्या</span>
                </div>
            </div>

            <!-- Missing -->
            <div class="stat-card warning">
                <i class="bi bi-person-dash-fill"></i>
                <div class="stat-info">
                    <span class="number">{{ data.total_stats.missing|to_nepali_num }}</span>
                    <span class="label">बेपत्ता</span>
                </div>
            </div>

            <!-- Injured -->
            <div class="stat-card info">
                <i class="bi bi-bandaid-fill"></i>
                <div class="stat-info">
                    <span class="number">{{ data.total_stats.injured|to_nepali_num }}</span>
                    <span class="label">घाइते</span>
                </div>
            </div>

            <!-- Estimated Loss -->
            <div class="stat-card dark">
                <i class="bi bi-cash-stack"></i>
                <div class="stat-info">
                    <span class="number">{{ data.total_stats.estimated_loss|to_nepali_num }}</span>
                    <span class="label">अनुमानित क्षति रु</span>
                </div>
            </div>

            <!-- Electricity Status -->
            <div
                class="stat-card {% if data.infrastructure.electricity == 'Normal' %}success{% else %}danger{% endif %}">
                <i class="bi bi-lightning-charge-fill"></i>
                <div class="stat-info">
                    <span class="number">
                        {{ 'नियमित' if data.infrastructure.electricity == 'Normal' else 'अवरुद्ध' if
                        data.infrastructure.electricity == 'Disrupted' else data.infrastructure.electricity }}
                    </span>
                    <span class="label">विद्युत सेवा</span>
                </div>
            </div>
        </div>

        <!-- Incident Overview by Ward -->
        <div class="report-content">
            <div class="section-title">
                <i class="bi bi-table"></i> वडा अनुसार घटना विबरण
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>वडा</th>
                        <th>जम्मा<br>घटना</th>
                        <th>मृत्यु</th>
                        <th>बेपत्ता</th>
                        <th>घाइते</th>
                        <th>अनुमानित<br>क्षति</th>
                        <th>सडक</th>
                        <th>विद्युत</th>
                        <th>संचार</th>
                        <th>पशुचौपाया</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward in range(1, 10) %}
                    <tr>
                        <td><strong>{{ ward|to_nepali_num }}</strong></td>
                        <td>{{ data.ward_stats[ward].total_incidents|to_nepali_num }}</td>
                        <td>{{ data.ward_stats[ward].deaths|to_nepali_num }}</td>
                        <td>{{ data.ward_stats[ward].missing|to_nepali_num }}</td>
                        <td>{{ data.ward_stats[ward].injured|to_nepali_num }}</td>
                        <td>{{ data.ward_stats[ward].estimated_loss|to_nepali_num }}</td>
                        <td>
                            {% if data.ward_stats[ward].road_blocked %}
                            <span class="badge bg-danger"><i class="bi bi-signpost-split-fill"></i></span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.ward_stats[ward].electricity_blocked %}
                            <span class="badge bg-danger"><i class="bi bi-lightning-charge-fill"></i></span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.ward_stats[ward].communication_blocked %}
                            <span class="badge bg-danger"><i class="bi bi-wifi"></i></span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ data.ward_stats[ward].livestock_loss|to_nepali_num }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td>जम्मा</td>
                        <td>{{ data.total_stats.incidents|to_nepali_num }}</td>
                        <td>{{ data.total_stats.deaths|to_nepali_num }}</td>
                        <td>{{ data.total_stats.missing|to_nepali_num }}</td>
                        <td>{{ data.total_stats.injured|to_nepali_num }}</td>
                        <td>{{ data.total_stats.estimated_loss|to_nepali_num }}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>{{ data.total_stats.livestock_death|to_nepali_num }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Disaster Type Summary -->
        <div class="report-content">
            <div class="section-title brown">
                <i class="bi bi-graph-up"></i> विपद् प्रकार अनुसार विवरण
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="brown">विपद्</th>
                        <th class="brown">जम्मा</th>
                        <th class="brown">मृत्यु<br>पुरुष</th>
                        <th class="brown">मृत्यु<br>महिला</th>
                        <th class="brown">बेपत्ता</th>
                        <th class="brown">घाइते<br>पुरुष</th>
                        <th class="brown">घाइते<br>महिला</th>
                        <th class="brown">प्रभावित<br>परिवार</th>
                        <th class="brown">घर<br>आं.क्षति</th>
                        <th class="brown">घर<br>पूर्ण.क्षति</th>
                        <th class="brown">सा.भवन<br>आं.क्षति</th>
                        <th class="brown">सा.भवन<br>पुर्ण.क्षति</th>
                        <th class="brown">पशु</th>
                        <th class="brown">अ.क्षति</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dtype, stats in data.disaster_type_stats.items() %}
                    {% if stats.total > 0 %}
                    <tr>
                        <td><strong>{{ dtype }}</strong></td>
                        <td>{{ stats.total|to_nepali_num }}</td>
                        <td>{{ stats.male_death|to_nepali_num }}</td>
                        <td>{{ stats.female_death|to_nepali_num }}</td>
                        <td>{{ stats.missing|to_nepali_num }}</td>
                        <td>{{ stats.male_injured|to_nepali_num }}</td>
                        <td>{{ stats.female_injured|to_nepali_num }}</td>
                        <td>{{ stats.affected_families|to_nepali_num }}</td>
                        <td>{{ stats.house_damaged|to_nepali_num }}</td>
                        <td>{{ stats.house_destroyed|to_nepali_num }}</td>
                        <td>{{ stats.public_building_damaged|to_nepali_num }}</td>
                        <td>{{ stats.public_building_destroyed|to_nepali_num }}</td>
                        <td>{{ stats.livestock_loss|to_nepali_num }}</td>
                        <td>{{ stats.estimated_loss|to_nepali_num }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% if not data.disaster_type_stats.values()|selectattr('total', 'gt', 0)|list %}
                    <tr>
                        <td colspan="14" class="text-center text-muted">कुनै घटना रिपोर्ट गरिएको छैन</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Infrastructure Status -->
        <div class="report-content">
            <div class="section-title gray">
                <i class="bi bi-hdd-network"></i> पूर्वाधारको स्थिति
            </div>
            <div class="infrastructure-grid">
                <div class="infrastructure-item">
                    <i
                        class="bi bi-lightning-charge-fill {% if data.infrastructure.electricity == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}"></i>
                    <span class="label">विद्युत:</span>
                    <span
                        class="{% if data.infrastructure.electricity == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}">
                        {{ 'सामान्य' if data.infrastructure.electricity == 'Normal' else 'अवरुद्ध' if
                        data.infrastructure.electricity == 'Disrupted' else data.infrastructure.electricity }}
                    </span>
                </div>
                <div class="infrastructure-item">
                    <i
                        class="bi bi-signpost-split-fill {% if data.infrastructure.road == 'Open' %}status-normal{% else %}status-disrupted{% endif %}"></i>
                    <span class="label">सडक:</span>
                    <span
                        class="{% if data.infrastructure.road == 'Open' %}status-normal{% else %}status-disrupted{% endif %}">
                        {{ 'सामान्य' if data.infrastructure.road == 'Open' else 'अवरुद्ध' if data.infrastructure.road ==
                        'Blocked' else data.infrastructure.road }}
                    </span>
                </div>
                <div class="infrastructure-item">
                    <i
                        class="bi bi-wifi {% if data.infrastructure.communication == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}"></i>
                    <span class="label">संचार:</span>
                    <span
                        class="{% if data.infrastructure.communication == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}">
                        {{ 'सामान्य' if data.infrastructure.communication == 'Normal' else 'अवरुद्ध' if
                        data.infrastructure.communication == 'Disrupted' else data.infrastructure.communication }}
                    </span>
                </div>
                <div class="infrastructure-item">
                    <i
                        class="bi bi-droplet-fill {% if data.infrastructure.drinking_water == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}"></i>
                    <span class="label">खानेपानी:</span>
                    <span
                        class="{% if data.infrastructure.drinking_water == 'Normal' %}status-normal{% else %}status-disrupted{% endif %}">
                        {{ 'सामान्य' if data.infrastructure.drinking_water == 'Normal' else 'अवरुद्ध' if
                        data.infrastructure.drinking_water == 'Disrupted' else data.infrastructure.drinking_water }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        {% if data.event_logs %}
        <div class="report-content" style="margin-bottom: 5px;">
            <div class="section-title gray">
                <i class="bi bi-journal-text"></i> हालका घटनाहरू
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="gray">समय</th>
                        <th class="gray">प्रकार</th>
                        <th class="gray">विवरण</th>
                        <th class="gray">स्थान</th>
                        <th class="gray">स्थिति</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in data.event_logs[:5] %}
                    <tr>
                        <td>{{ (event.timestamp.split()[1][:5] if ' ' in event.timestamp else
                            event.timestamp[:5])|to_nepali_num }}</td>
                        <td>{{ event.event_type }}</td>
                        <td style="text-align: left;">{{ event.description[:60] }}{% if event.description|length > 60
                            %}...{% endif %}</td>
                        <td>{{ event.location or '-' }}</td>
                        <td>
                            <span class="badge-status 
                                {% if event.status == 'Active' %}badge-active
                                {% elif event.status == 'Completed' %}badge-completed
                                {% else %}badge-pending{% endif %}">
                                {% if event.status == 'Active' %}सक्रिय
                                {% elif event.status == 'Completed' %}सम्पन्न
                                {% else %}बाँकी{% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Public Advisories -->
        {% if data.public_advisories %}
        <div class="report-content">
            <div class="section-title" style="background-color: #d69e2e;">
                <i class="bi bi-megaphone"></i> सार्वजनिक सूचना/सल्लाह
            </div>
            {% set advisory = data.public_advisories[0] %}
            <div
                class="advisory-item {% if advisory.priority == 'Critical' %}critical{% elif advisory.priority == 'High' %}high{% endif %}">
                <strong>{{ advisory.title }}</strong>
                <span
                    class="badge {% if advisory.priority == 'Critical' %}bg-danger{% elif advisory.priority == 'High' %}bg-warning{% else %}bg-info{% endif %}">
                    {{ 'अत्यन्त जरुरी' if advisory.priority == 'Critical' else 'उच्च' if advisory.priority == 'High'
                    else 'सामान्य' if advisory.priority == 'Normal' else advisory.priority }}
                </span>
                <br>
                <small>{{ advisory.content[:300] }}{% if advisory.content|length > 300 %}...{% endif %}</small>
            </div>
        </div>
        {% endif %}

        <!-- Situation Report Summary -->
        {% if data.situation_report %}
        <div class="report-content" style="margin-bottom: 5px;">
            <div class="section-title" style="background-color: #38a169;">
                <i class="bi bi-clipboard-data"></i> स्थितिको सारांश
            </div>
            <div style="padding: 10px; background-color: #f0fff4; border-radius: 4px; font-size: 9pt;">
                <p><strong>वर्तमान अवस्था:</strong> {{ data.situation_report.current_situation_summary or 'खुलेको छैन'
                    }}
                </p>
                {% if data.situation_report.resources_deployed %}
                <p><strong>परिचालित स्रोतहरू:</strong> {{ data.situation_report.resources_deployed }}</p>
                {% endif %}
                {% if data.situation_report.next_update_time %}
                <p><strong>अर्को अपडेट:</strong> {{ data.situation_report.next_update_time|to_nepali_num }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Report Footer -->
        <div class="report-footer">
            <p>प्रतिवेदन तयार गरिएको मिति: {{ generated_at.strftime('%Y-%m-%d %H:%M')|to_nepali_num }} | LEOC थलारा
                गाउँपालिका
            </p>
            <p style="font-size: 8pt; margin-top: 5px;">
                यो स्थानीय आपतकालीन कार्य केन्द्रको आधिकारिक कागजात हो।
                आपतकालीन अवस्थाका लागि LEOC सञ्चालन कक्षमा सम्पर्क गर्नुहोस्।
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        window.jsPDF = window.jspdf.jsPDF;
        function applyFilter() {
            const fromDate = document.getElementById('fromDateBS').value;
            const toDate = document.getElementById('toDateBS').value;

            if (fromDate && toDate) {
                if (fromDate === toDate) {
                    window.location.href = '/daily-report-preview?bs_date=' + fromDate;
                } else {
                    window.location.href = '/daily-report-preview?from_bs_date=' + fromDate + '&to_bs_date=' + toDate;
                }
            } else {
                alert('Please enter both From and To dates');
            }
        }

        async function saveAsPDF() {
            const reportContainer = document.querySelector('.container');
            const fileName = 'Daily_Report_{{ start_bs }}{% if start_bs != end_bs %}_to_{{ end_bs }}{% endif %}.pdf';

            const btn = event.currentTarget || event.target;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> तयार गर्दै...';
            btn.disabled = true;

            const a4WidthPx = 794;

            try {
                const canvas = await html2canvas(reportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    windowWidth: a4WidthPx,
                    onclone: (clonedDoc) => {
                        const clonedContainer = clonedDoc.querySelector('.container');
                        if (clonedContainer) {
                            clonedContainer.style.width = a4WidthPx + 'px';
                            clonedContainer.style.maxWidth = 'none';
                            clonedContainer.style.margin = '0 auto';
                            clonedContainer.style.padding = '10mm';
                        }
                    }
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                // Set margins (15mm top & bottom)
                const margin = 15;
                const usableHeight = pdfHeight - (margin * 2);

                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const imgHeightOnPdf = (canvasHeight * pdfWidth) / canvasWidth;

                let heightLeft = imgHeightOnPdf;
                let position = margin;

                const addMasks = (doc) => {
                    doc.setFillColor(255, 255, 255);
                    doc.rect(0, 0, pdfWidth, margin, 'F');
                    doc.rect(0, pdfHeight - margin, pdfWidth, margin, 'F');
                };

                // Add first page
                pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeightOnPdf);
                addMasks(pdf);
                heightLeft -= usableHeight;

                // Add extra pages if content is long
                while (heightLeft > 0) {
                    pdf.addPage();
                    position -= usableHeight;
                    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeightOnPdf);
                    addMasks(pdf);
                    heightLeft -= usableHeight;
                }

                pdf.save(fileName);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('PDF सुरक्षित गर्न समस्या भयो।');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function saveAsImage() {
            const reportContainer = document.querySelector('.container');
            const fileName = 'Daily_Report_{{ start_bs }}{% if start_bs != end_bs %}_to_{{ end_bs }}{% endif %}.png';

            const btn = event.currentTarget || event.target;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> तयार गर्दै...';
            btn.disabled = true;

            const a4Width = 794;

            try {
                const canvas = await html2canvas(reportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    windowWidth: a4Width,
                    onclone: (clonedDoc) => {
                        const clonedContainer = clonedDoc.querySelector('.container');
                        if (clonedContainer) {
                            clonedContainer.style.width = a4Width + 'px';
                            clonedContainer.style.maxWidth = 'none';
                            clonedContainer.style.padding = '20px';
                        }
                    }
                });

                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png');
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Image सुरक्षित गर्न समस्या भयो।');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }


        // Auto-print on load if requested
        if (window.location.search.includes('autoprint=1')) {
            window.onload = function () {
                setTimeout(function () {
                    window.print();
                }, 500);
            };
        }
    </script>
</body>

</html>